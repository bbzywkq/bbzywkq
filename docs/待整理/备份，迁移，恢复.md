# 备份，迁移，恢复


# 备份
备份命令

`gitlab-rake gitlab:backup:create`

备份文件

默认将会在 /var/opt/gitlab/backups/ 目录下生成备份文件。

复制文件到宿主机并下载

`docker cp gitlab:/var/opt/gitlab/backups/1641291695_2022_01_04_13.7.4_gitlab_backup.tar /root`

`docker cp /root/1641291695_2022_01_04_13.7.4_gitlab_backup.tar gitlab2:/var/opt/gitlab/backups/`



# 恢复
将备份文件权限修改为777，避免出现权限不够的问题

```bash
cd /var/opt/gitlab/backups
rm rf tmp/ #删除无用临时文件
chomd 777 1561597102_2019_06_27_12.0.1_gitlab_backup.tar
```
停止数据连接服务

```bash
gitlab-ctl stop unicorn
gitlab-ctl stop sidekiq
```
恢复备份文件到GitLab

`gitlab-rake gitlab:backup:restore BACKUP=备份文件编号`

例如：备份文件名为`1561597102_2019_06_27_12.0.1_gitlab_backup.tar`，则编号为`1561597102_2019_06_27_12.0.1`。
在提示中敲入“yes”继续。

启动GitLab

gitlab-ctl start

最后检查新旧GitLab的内容，完全一模一样，迁移成功！